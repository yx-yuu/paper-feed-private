name: Auto RSS Fetch

on:
  schedule:
    - cron: '0 */6 * * *'  # run every 6 hours
  workflow_dispatch:
    inputs:
      rebuild:
        description: 'Rebuild feed from scratch (ignore existing XML)'
        required: false
        default: false
        type: boolean
      dblp_enrich_arxiv:
        description: 'Enrich DBLP entries with arXiv abstracts'
        required: false
        default: false
        type: boolean
      dblp_enrich_max:
        description: 'Max DBLP→arXiv enrichments per run'
        required: false
        default: '30'
        type: string
      min_year:
        description: 'Only include items published in or after this year'
        required: false
        default: '2022'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Allow the workflow to push updated RSS XML back to the repository.
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run RSS Script
      env: 
        RSS_JOURNALS: ${{ secrets.RSS_JOURNALS }}
        RSS_KEYWORDS: ${{ secrets.RSS_KEYWORDS }}
        RSS_FEISHU_WEBHOOK: ${{ secrets.RSS_FEISHU_WEBHOOK }}
        PYTHONDONTWRITEBYTECODE: '1'
      run: |
        set -euo pipefail
        ARGS="--prune-existing"

        MIN_YEAR="${{ github.event.inputs.min_year }}"
        if [ -n "${MIN_YEAR}" ]; then
          ARGS="${ARGS} --min-year ${MIN_YEAR}"
        fi

        if [ "${{ github.event.inputs.rebuild }}" = "true" ]; then
          ARGS="${ARGS} --rebuild"
        fi

        if [ "${{ github.event.inputs.dblp_enrich_arxiv }}" = "true" ]; then
          ENRICH_MAX="${{ github.event.inputs.dblp_enrich_max }}"
          if [ -z "${ENRICH_MAX}" ]; then
            ENRICH_MAX="30"
          fi
          ARGS="${ARGS} --dblp-enrich-arxiv --dblp-enrich-max ${ENRICH_MAX}"
        fi

        python get_RSS.py ${ARGS}

    - name: Commit and Push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add filtered_feed.xml
        # 只有当有新文件生成或文件变动时才提交
        git commit -m "Auto-update RSS feed" || echo "No changes to commit"
        git push
